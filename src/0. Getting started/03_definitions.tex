\begin{quote}
  Знакомство с анализом временных рядов было бы странно начинать без
  объяснения, что же собственно временные ряды из себя представляют.
  К нашему удивлению, авторы многих учебников не удосуживаются этого
  сделать, а ведь именно в определении скрыта львиная доля критически важных
  особенностей рядов, без понимания которых их анализ будет ошибочным.
\end{quote}

\section*{Немного про то, откуда берутся временные ряды}

\defn{Случайная функция}{
  Пусть \( T \) - произвольное множество, \( (\Omega, \mathcal{F},
  \mathbb{P}) \) - вероятностное пространство.

  Тогда отображение \[ X : T \times \Omega \to \mathbb{R} \] называется
  случайной функцией, если для
  любого \( t \in T \) функция \[ X(t, \omega) := X_t(\omega) = X_t,
  \quad \omega \in \Omega, \]  является случайной величиной на \(
  (\Omega, \mathcal{F}, \mathbb{P}) \).
}

Наиболее важные виды случайных функций:
\begin{enumerate}
  \item случайные процессы (stochastic processes, random processes):
    \( T \subset \mathbb{R} \)
    \begin{enumerate}
      \item случайные процессы с дискретным временем: \( T =
        \mathbb{Z}_+ \) (иногда \( T = \mathbb{Z} \))
      \item случайные процессы с непрерывным временем: \( T = [0,
        \infty) \) (иногда \( T = \mathbb{R} \))
    \end{enumerate}
  \item Cлучайные поля: \( T \subset R^k, \quad k \geq 2 \).
\end{enumerate}

\defn{Траектория процесса}{
  Траекторией случайного процесса \( X_t \)
  называется отображение \( t \mapsto X_t(\omega) \) при
  фиксированном \( \omega \).
  Конечномерным распределением случайного процесса \( X_t \)
  называется распределение вектора \( (X_{t_1}, X_{t_2}, \ldots,
  X_{t_n}) \) для фиксированного набора моментов
  времени \( t_1, t_2, \ldots, t_n \).
}

\defn{Временной ряд}{
  Временным рядом \( Y_t \) называется
  набор значений траектории случайного процесса,
  измеренных в наблюдаемые моменты времени. Он представляет собой
  дискретизированную или наблюдаемую версию траектории случайного процесса.
}

Если присмотреться к определению выше, то можно заметить,
что главное отличие временного ряда от
других типов данных — важность
временного порядка. Не только само значение, но и момент его
измерения имеют значение. Дело в том, что проводя наблюдения за
каким-то природным явлением, мы вовсе не
извлекаем получаемые значения из одной и той же генеральной
совокупности. Даже если
настройки прибора и положение датчиков не менялись, состояние
измеряемого объекта в каждый новый момент времени будет другое.
Попросту говоря, это будет уже другая случайная величина. Серию
измерений, выполненных одним и тем же прибором, даже неподвижно
стоящим под одной и той же горой, нельзя рассматривать, как серию
выборок из одного и того же пространства элементарных событий. Для
описания случайного процесса, в отличие от случайной величины,
недостаточно задать его функцию
распределения один раз. Просто потому, что в различные моменты времени
$t$ она может быть разной. А еще для случайного процесса надо
определить функцию совместного распределения вероятностей для
моментов времени $t$ и $t+\delta t$ и так далее (чтобы учесть эффект памяти).

Чтобы оценить эти функции, наблюдая за случайным процессом, нужна не
одна реализация, а целый
ансамбль реализации одного и того же случайного процесса. Тогда
и только тогда для каждого момента времени у нас будет несколько
измерений одной и той же случайной величины. Только в таком случае
становятся применимы все привычные статистические методы. Именно
игнорирование данного свойства временных рядов приводят к
парадоксальным и ошибочным результатам вроде широко известной
статистически значимой
\href{https://www.ntu.ac.uk/__data/assets/pdf_file/0038/676946/Fairhurst.pdf}{корреляции
между числом пиратов и глобальным потеплением.}

% TODO: добавить ссылку на главу с ложными корреляциями

Но что же делать, если у нас есть только одна Земля? Как изучать
взаимосвязи между процессами, каждый из которых мы наблюдаем в
единственном экземпляре? Проблема эта невероятно сложная,
практически нерешаемая. Мы еще вернемся к ней, когда будем говорить
о свойствах случайных процессов, в частности о стационарности и
эргодичности (см. \autoref{chap:properties}).
% TODO сделать чтобы было на русском
Пока что укажем, что для некоторых классов случайных
процессов, все характеристики которых неизменны во времени, наличие
ансамбля не обязательно. То есть, нам не потребуются сотни
реализаций, чтобы оценить какую-нибудь статистику, вместо этого
достаточно некоторое время понаблюдать за одной. Например, чтобы
оценить коэффициент корреляции между $X$ и $Y$, достаточно иметь одну
реализацию $X$ и еще одну – $Y$.

Но что же делать с остальными рядами, теми которые не имеют таких
приятных свойств. Рядами с трендами, сезонными и суточными
циклами, и т.д.? Как искать связь между ними и оценивать ее
значимость? Как строить предиктивные модели, если даже сходимость
оценки автокорреляционной функции не гарантирована? На этот вопрос мы в том
числе попытаемся найти ответ в данном учебнике.

Пока же следует запомнить, что общая проблема алгоритмов обработки
временных рядов — это отсутствие математической строгости. Ведь даже когда
мы используем для анализа экспериментальных сигналов алгоритмы со
строгим обоснованием и доказанной оптимальностью, у нас всегда
остается открытым вопрос о том, не нарушены ли условия применимости
таких алгоритмов? Ведь любой алгоритм всегда начинается с требования,
что исходные данные должны обладать вполне
определенными свойствами. Но когда мы имеем дело с
эмпирическими данными, доказать выполнение этих требований
почти невозможно. Поэтому было бы наивно думать, что корректность
результата можно гарантировать строгостью метода. На практике
использование строгих методов не дает никаких преимуществ, если с
тем же уровнем строгости не доказана адекватность модели данных, в
рамках которой сформулирован метод. При режимных наблюдениях это
почти невозможно. В лучшем случае можно только предполагать, что
«базовая модель» сигнала вполне адекватна реальным данным. В худшем
(и, к сожалению, более типичном) случае, наоборот, имеются видимые
несоответствия между требованиями теоретической модели и
экспериментальным сигналом. Но если у нас нет уверенности в
адекватности используемой модели данных, это ставит под сомнение и
все результаты, полученные в рамках такой модели.

% TODO: добавить ссылку на главу про метрики
При этом хорошие финальные метрики модели. совершенно не гарантируют,
что модель адекватна. Низкая дисперсия остатков на тестовой выборке -
это хорошо, однако если это лишь достаточное условия качества модели.
Если же свойства временного ряда не соответствуют аксиомам модели, а
также условиям проведения эксперимента, то MSE на тесте мало чего
говорит о соответствии модели и данных.

Поэтому не надейтесь, что какая-то типовая модель будет хорошо
аппроксимировать ваш ряд. В практике изредка встречаются совершенно стандартные
временные ряды, в точности подходящие под условия применимости той
или иной типовой модели. Но гораздо чаще такого соответствия нет.

С одной стороны, такая постановка проблемы может обескуражить -
кажется, что не существует универсального рецепта построения
идеальной модели временного ряда. С другой стороны, все это дает
право на гибкость и вольность мысли.
При изложении материала мы бы хотели, чтобы читатели постоянно
держали в голове связь между временным рядом и свойствами
породившего его случайного процесса.

Мы верим в то, что именно понимание специфических
свойств временного ряда и случайного процесса, его генерирующего,
способно привести к пониманию, как
построить наиболее точный и устойчивый прогноз. Как следствие, мы
не хотим тратить слишком много времени на разъяснение механизмов
работы конкретных моделей временных рядов или алгоритмов машинного
обучения. Вместо этого мы бы хотели, чтобы у читателей
сформировалось понимание, какие особенности исходных данных
пытались решить создатели того или иного алгоритма. Сфокусироваться
на исходном problem space, а не на текущем solution space
(тем более, что он постоянно меняется, появляются все новые алгоритмы
  предобработки данных, все новые алгоритмы машинного обучения, схемы
обучения и т.д.).

После столь пессимистичного начала возникает вопрос: а что же делать
и как жить без готовых моделей. Снова оговоримся, что готовых рецептов в
данном случае не существует. Однако базовые принципы примерно таковы:

\begin{enumerate}
  \item Если вы хотите глубоко разобраться в структуре
    сигнала и научиться его качественно прогнозировать, не пытайтесь
    сходу применять какие-либо модели к ряду в целом. Постарайтесь сперва
    понять природу вашего ряда, вникнуть в его
    экономическую/физическую суть прежде чем приступать к
    статистическим методам. Это может уберечь вас от многих при
    интерпретации результатов количественных методов.
  \item Исходя из анализы природы ряда, разберите его на
    детали. То есть, начните с декомпозиции сигнала на составляющие с
    максимально простыми свойствами, по возможности опираясь при этом на
    физику/экономику явления.

    \ex{}{
      Если перед вами стоит задача предсказания прибыли компании,
      имеет смысл предварительно
      представить ее в виде разности выручки и затрат и далее
      отдельно прогнозировать
      каждую компоненту. Вспомним базовую микроэкономику:

      \[
        \begin{aligned}
          \text{Profit} &= \text{Total Revenue} - \text{Total Costs} \\
          \text{Total Revenue} &= \text{Average Check} \times
          \text{Quantity Sold} \\
          \text{Total Costs} &= \text{Variable Costs} + \text{Fixed Costs} \\
          \text{Variable Costs} &= \text{Average Variable Cost}
          \times \text{Quantity Sold} \\
          \text{Profit} &= (\text{Average Check} - \text{Average
          Variable Cost}) \times
          \text{Quantity Sold} - \text{Fixed Costs}
        \end{aligned}
      \]

      Разложив прибыль в итоговом виде, мы можем создать
      предсказательную модель для каждого элемента и затем получить
      итоговый прогноз прибыль, собрав в композицию прогнозы.
    }

    Далее можно переходить к
    статистическому разложению.

    \ex{}{

      Например, в экономике это может быть
      тренд, сезонная и календарная и/или недельная компоненты,
      эффекты возмущений
      (праздники и т.п.), разовые события (ковид, военные действия),
      квазислучайная составляющая и т.д.
    }

    Предварительный предметный
    анализ, в особенности декомпозиция ряда являются основными
    элементами разведочного анализа (EDA) временного ряда.
    Чтобы найти и выделить эти компоненты, начните с разведочного
    анализа (советую для этих целей ознакомиться с \cite{tukeyEDA1981})

  \item Затем, зная основные элементы сигнала, выделите каждую
    составляющую в чистом виде. Отдельно - стационарные, отдельно
    нестационарные. После чего можно строить техническую модель каждой
    составляющей, разглядывая ее буквально "под микроскопом". Если вы
    хотите иметь хороший прогноз, то это единственный путь. Что
    является хорошим прогнозом, мы рассказываем в
    \autoref{sec:forecast_quality}

  \item Очень многие ряды в принципе не позволяют давать точные
    прогнозы - таковы внутренние свойства сигнала, в частности
    рыночные котировки в силу тех или иных гипотез эффективного
    рынка имеют низкое соотношение сигнал-шум. С такими рядами
    нужно быть особенно осторожными, поскольку при некорректно
    сформулированном эксперименте довольно легко подогнать
    какую-то модель, особенно если у нее достаточно много
    параметров или если вы переобучитесь на
    бэктесте. Но как только вы выйдете за тестовые данные, прогноз
    может сильно потерять в качестве.
  \item Поэтому ключевой аспект прогнозирования - это поиск
    закономерностей в сигнале. Все "модели" фактически именно этим
    и занимаются. Причем часто их
    результаты обусловлены базовыми гипотезами. Предварительный
    анализ (EDA) по сути для того и нужен, чтобы уловить
    взаимосвязь между свойствами временного ряда и используемой моделью.

  \item Всегда анализируйте остатки. В идеале, они должны быть
    случайны. Если это не так - значит, модель
    систематически отклоняется от данных. В лучшем случае это значит, что
    в сигнале есть какие-то дополнительные закономерности, которые в
    модели не учтены, и, следовательно, прогноз мог бы быть лучше (если
    их учесть). В худшем - что модель просто кривая (нарушены условия
    применимости и т.д.). Уточню еще, что анализировать остатки надо
    именно по обучающей выборке, а то инет-поиск на "анализ остатков"
  чаще всего выводит на остатки (погрешности) прогноза, что немного другое).
  Анализ остатков более подробно мы обсудим в \autoref{sec:metrics}.
  % TODO: не понял, почему именно на обучающей выборке
\end{enumerate}

\printbibliography[heading=subbibliography, title={Источники}]
